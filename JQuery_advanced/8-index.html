<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Task 8</title>
  </head>
  <body>
    <!-- jQuery FULL minified (NOT slim) to access $.ajax -->
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      type="application/javascript"
    ></script>

    <script type="application/javascript">
      function createSearchForm() {
        const $textInput = $("<input>", { type: "text" }); // no id/name/class
        const $submitInput = $("<input>", { type: "submit", value: "Submit" });
        const $results = $("<ul>");
        const $pagination = $("<ul>", { id: "pagination" });

        $("body").append($textInput, $submitInput, $results, $pagination);

        $submitInput.click(function (e) {
          e.preventDefault();
          queryWikipedia($textInput.val(), 0);
        });
      }

      function addNewArticle(id, title, snippet) {
        const $li = $("<li>");

        const $p1 = $("<p>").append(
          $("<span>").text(id + " - "),
          $("<b>").text(title)
        );

        // snippet contains HTML => must display as HTML
        const $p2 = $("<p>").html(snippet);

        $li.append($p1, $p2);
        $("ul").first().append($li); // first ul is results
      }

      function buildPagination(numberOfItems, itemsPerPage, currentOffset) {
        $("#pagination").empty();

        const pages = Math.ceil(numberOfItems / itemsPerPage);

        for (let page = 1; page <= pages; page += 1) {
          const pageOffset = (page - 1) * itemsPerPage;

          const $li = $("<li>")
            .text(page)
            .css("cursor", "pointer")
            .css("margin-left", "10px")
            .css("display", "inline");

          if (pageOffset === currentOffset) {
            $li.css("font-weight", "bold");
          }

          $li.click(function () {
            // reuse current search value from the text input
            const searchValue = $('input[type="text"]').val();
            queryWikipedia(searchValue, pageOffset);
          });

          $("#pagination").append($li);
        }
      }

      function queryWikipedia(search, offset = 0) {
        const itemsPerPage = 10;

        const data = {
          action: "query",
          list: "search",
          srsearch: search,
          srlimit: itemsPerPage,
          sroffset: offset,
          format: "json",
          origin: "*",
        };

        $.ajax({
          url: "https://en.wikipedia.org/w/api.php",
          method: "GET",
          data: data,
          success: function (response) {
            $("ul").first().empty(); 
            const results =
              response &&
              response.query &&
              response.query.search
                ? response.query.search
                : [];

            results.forEach(function (result) {
              addNewArticle(
                String(result.pageid),
                String(result.title),
                String(result.snippet)
              );
            });

            const totalHits =
              response &&
              response.query &&
              response.query.searchinfo &&
              typeof response.query.searchinfo.totalhits === "number"
                ? response.query.searchinfo.totalhits
                : 0;

            buildPagination(totalHits, itemsPerPage, offset);
          },
          error: function () {
            $("ul").first().empty();
            $("#pagination").empty();
          },
        });
      }

      $(function () {
        createSearchForm();
      });
    </script>
  </body>
</html>
